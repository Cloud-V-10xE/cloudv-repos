name: Central Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"  # Adjust for daily or monthly releases

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Set release date
        id: date
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI and jq
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: Download latest artifacts dynamically
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release_assets
          
          WORKFLOWS=("build-bazelisk.yml" "build-coreutils.yml" "build-strace.yml" "build-binutils.yml" "build-transformers.yml")

          for WF in "${WORKFLOWS[@]}"; do
            echo "Processing workflow $WF"

            # Find latest successful run on main branch
            LATEST_RUN_ID=$(gh run list --workflow="$WF" --branch=main --limit 20 --json databaseId,status \
              | jq -r '.[] | select(.status=="completed") | .databaseId' | head -n1)

            if [ -z "$LATEST_RUN_ID" ]; then
              echo "⚠️ No successful run found for $WF, skipping"
              continue
            fi

            # Download all artifacts from that run
            ARTIFACTS=$(gh run view $LATEST_RUN_ID --json artifacts | jq -r '.artifacts[].name')

            for ART in $ARTIFACTS; do
              echo "Downloading $ART from $WF"
              gh run download $LATEST_RUN_ID --name "$ART" -D release_assets
            done
          done

      - name: List downloaded artifacts
        run: ls -lh release_assets

      - name: Verify all expected artifacts are present
        run: |
          EXPECTED=("bazelisk" "coreutils" "strace" "binutils" "transformers")
          MISSING=0
          for E in "${EXPECTED[@]}"; do
            if ! ls release_assets | grep -q "$E"; then
              echo "⚠️ Artifact $E missing!"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then
            echo "⚠️ Some artifacts are missing but proceeding with release."
          else
            echo "✅ All expected artifacts are present"
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.release_date }}
          name: Release ${{ steps.date.outputs.release_date }}
          files: release_assets/*
          body: |
            Central release for date ${{ steps.date.outputs.release_date }}  
            Includes all latest binaries from build workflows:
            - Bazelisk
            - Coreutils
            - Strace
            - Binutils
            - Transformers
