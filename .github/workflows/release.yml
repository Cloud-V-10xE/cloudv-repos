name: Central Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"  # Daily at 1:00 AM or monthly if you want

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Set release date
        id: date
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: Download latest artifacts dynamically
        run: |
          mkdir -p release_assets
          
          WORKFLOWS=("build-bazelisk.yml" "build-coreutils.yml" "build-strace.yml" "build-binutils.yml" "build-transformers.yml")

          for WF in "${WORKFLOWS[@]}"; do
            echo "Processing workflow $WF"

            # Find latest successful run on main branch
            LATEST_RUN_ID=$(gh run list --workflow="$WF" --branch=main --limit 20 --json databaseId,status \
              | jq -r '.[] | select(.status=="completed") | .databaseId' | head -n1)

            if [ -z "$LATEST_RUN_ID" ]; then
              echo "⚠️ No successful run found for $WF, skipping"
              continue
            fi

            # Find artifact name dynamically (just grab the first artifact)
            ARTIFACT_NAME=$(gh run view $LATEST_RUN_ID --json artifacts | jq -r '.artifacts[0].name')

            if [ -z "$ARTIFACT_NAME" ] || [ "$ARTIFACT_NAME" == "null" ]; then
              echo "⚠️ No artifact found for $WF, skipping"
              continue
            fi

            echo "Downloading latest artifact $ARTIFACT_NAME from workflow $WF"
            gh run download $LATEST_RUN_ID --name "$ARTIFACT_NAME" -D release_assets
          done

      - name: List downloaded artifacts
        run: ls -lh release_assets

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.release_date }}
          name: Release ${{ steps.date.outputs.release_date }}
          files: release_assets/*
          body: |
            Central release for date ${{ steps.date.outputs.release_date }}  
            Includes all latest binaries from build workflows
