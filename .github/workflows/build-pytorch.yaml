name: Build PyTorch for RISC-V

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  build:
    runs-on: RISCV64
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.get-latest-tag.outputs.tag_name }}
      release_name: ${{ steps.get-version.outputs.release_name }}
      asset_name: ${{ steps.get-version.outputs.asset_name }}
      asset_path: ${{ steps.get-version.outputs.asset_path }}

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            cmake \
            ninja-build \
            libopenblas-dev \
            liblapack-dev \
            libprotobuf-dev \
            protobuf-compiler \
            libffi-dev \
            python3-dev \
            python3-pip \
            python3-venv \
            ccache \
            wget \
            curl

      - name: Clean workspace with elevated permissions
        run: |
          sudo rm -rf "$GITHUB_WORKSPACE"
          mkdir -p "$GITHUB_WORKSPACE"

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Setup directories
        run: mkdir -p "$GITHUB_WORKSPACE/build_output"

      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          python3 --version
          cmake --version
          nproc

      - name: Clone PyTorch and checkout latest tag
        id: get-latest-tag
        run: |
          set -eux
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0

          rm -rf "$GITHUB_WORKSPACE/pytorch"
          git clone --depth=1 --no-tags https://github.com/pytorch/pytorch.git "$GITHUB_WORKSPACE/pytorch"
          cd "$GITHUB_WORKSPACE/pytorch"

          git fetch --tags --depth=1
          LATEST_TAG=$(git tag -l "v*.*.*" | grep -v "rc" | grep -v "dev" | sort -V | tail -n 1)
          echo "Checking out $LATEST_TAG"
          git fetch --depth=1 origin tag "$LATEST_TAG"
          git checkout FETCH_HEAD

          git submodule sync
          git submodule update --init --recursive --depth=1

          echo "tag_name=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Setup Python virtual environment
        run: |
          python3 -m venv "$GITHUB_WORKSPACE/pytorch-build-env"
          source "$GITHUB_WORKSPACE/pytorch-build-env/bin/activate"

          pip install --upgrade pip wheel setuptools
          pip install \
            numpy \
            pyyaml \
            cmake \
            cffi \
            typing_extensions \
            future \
            six \
            requests \
            dataclasses \
            filelock \
            networkx \
            jinja2 \
            sympy

      - name: Configure build environment
        run: |
          cat >> "$GITHUB_ENV" << 'EOF'
          USE_CUDA=0
          USE_ROCM=0
          USE_CUDNN=0
          USE_DISTRIBUTED=0
          USE_MKLDNN=0
          USE_NNPACK=0
          USE_QNNPACK=0
          USE_PYTORCH_QNNPACK=0
          USE_FBGEMM=0
          USE_KINETO=0
          USE_NCCL=0
          USE_SYSTEM_NCCL=0
          BUILD_TEST=0
          USE_NUMPY=1
          USE_OPENMP=1
          USE_SYSTEM_BLAS=1
          USE_SYSTEM_LAPACK=1
          CMAKE_BUILD_TYPE=Release
          MAX_JOBS=64
          EOF

      - name: Build PyTorch
        run: |
          source "$GITHUB_WORKSPACE/pytorch-build-env/bin/activate"
          cd "$GITHUB_WORKSPACE/pytorch"

          echo "Building PyTorch at $(date)"
          echo "Using $(nproc) CPU cores"

          python setup.py bdist_wheel 2>&1 | tee "$GITHUB_WORKSPACE/build.log"

          echo "Build completed at $(date)"

      - name: Verify build
        run: |
          source "$GITHUB_WORKSPACE/pytorch-build-env/bin/activate"
          pip install --no-deps "$GITHUB_WORKSPACE/pytorch"/dist/torch-*.whl
          cd "$HOME"
          python -c "import torch; print(torch.__version__)"

      - name: Run Test Suite
        run: |
          source "$GITHUB_WORKSPACE/pytorch-build-env/bin/activate"
          cd "$GITHUB_WORKSPACE/pytorch"

          pip install -r .ci/docker/requirements-ci.txt

          echo "Running PyTorch test suite at $(date)"
          python test/run_test.py --verbose \
            --include test_torch test_nn test_autograd

      - name: Get PyTorch version and set outputs
        id: get-version
        run: |
          source "$GITHUB_WORKSPACE/pytorch-build-env/bin/activate"
          cd "$HOME"

          PYTORCH_VERSION=$(python -c "import torch; print(torch.__version__)")
          WHEEL_FILE=$(ls "$GITHUB_WORKSPACE/pytorch/dist"/torch-*.whl | head -1)
          WHEEL_BASENAME=$(basename "$WHEEL_FILE")

          ASSET_PATH="$GITHUB_WORKSPACE/build_output/${WHEEL_BASENAME}"
          cp "$WHEEL_FILE" "$ASSET_PATH"

          echo "release_name=PyTorch ${PYTORCH_VERSION} RISC-V" >> "$GITHUB_OUTPUT"
          echo "asset_name=$WHEEL_BASENAME" >> "$GITHUB_OUTPUT"
          echo "asset_path=$ASSET_PATH" >> "$GITHUB_OUTPUT"
          echo "pytorch_version=$PYTORCH_VERSION" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get-version.outputs.asset_name }}
          path: ${{ steps.get-version.outputs.asset_path }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ steps.get-version.outputs.pytorch_version }}
          path: ${{ github.workspace }}/build.log
