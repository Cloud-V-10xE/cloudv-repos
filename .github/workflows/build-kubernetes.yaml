name: Build Kubernetes for Multiple Architectures

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      k8s_tag: ${{ steps.get-versions.outputs.k8s_tag }}
      cni_version: ${{ steps.get-versions.outputs.cni_version }}
      flannel_version: ${{ steps.get-versions.outputs.flannel_version }}
    steps:
      - name: Get latest versions
        id: get-versions
        run: |
          K8S_TAG=$(curl -s https://api.github.com/repos/kubernetes/kubernetes/tags | \
            jq -r '.[].name' | \
            grep -v -E 'alpha|beta|rc' | \
            grep '^v1\.' | \
            sort -V | \
            tail -n 1)

          CNI_VERSION=$(curl -s https://api.github.com/repos/containernetworking/plugins/releases/latest | \
            jq -r '.tag_name')

          FLANNEL_VERSION=$(curl -s https://api.github.com/repos/flannel-io/flannel/releases/latest | \
            jq -r '.tag_name')

          echo "Kubernetes version: $K8S_TAG"
          echo "CNI plugins version: $CNI_VERSION"
          echo "Flannel version: $FLANNEL_VERSION"

          echo "k8s_tag=$K8S_TAG" >> "$GITHUB_OUTPUT"
          echo "cni_version=$CNI_VERSION" >> "$GITHUB_OUTPUT"
          echo "flannel_version=$FLANNEL_VERSION" >> "$GITHUB_OUTPUT"

  build-x86:
    needs: get-versions
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            rsync \
            jq \
            curl \
            wget

      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          ldd --version

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Clone Kubernetes and checkout version
        run: |
          set -eux
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0

          rm -rf kubernetes
          git clone --depth=1 --no-tags https://github.com/kubernetes/kubernetes.git
          cd kubernetes
          git fetch --depth=1 origin tag "${{ needs.get-versions.outputs.k8s_tag }}"
          git checkout FETCH_HEAD

      - name: Build Kubernetes binaries for x86_64
        run: |
          cd kubernetes
          go mod download
          echo "Building Kubernetes for linux/amd64..."
          KUBE_BUILD_PLATFORMS=linux/amd64 make all WHAT="cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/kube-proxy cmd/kubectl cmd/kubeadm"
          echo "Build completed!"

      - name: Download CNI plugins for x86_64
        run: |
          CNI_VERSION="${{ needs.get-versions.outputs.cni_version }}"
          wget -q "https://github.com/containernetworking/plugins/releases/download/${CNI_VERSION}/cni-plugins-linux-amd64-${CNI_VERSION}.tgz"
          mkdir -p cni-plugins-amd64
          tar -xzf "cni-plugins-linux-amd64-${CNI_VERSION}.tgz" -C cni-plugins-amd64/

      - name: Build Flannel for x86_64
        run: |
          git clone --depth=1 \
            --branch "${{ needs.get-versions.outputs.flannel_version }}" \
            https://github.com/flannel-io/flannel.git
          cd flannel
          make dist/flanneld-amd64

      - name: Package binaries
        run: |
          cd kubernetes

          if [ -d "_output/local/go/bin" ]; then
            BIN_DIR="_output/local/go/bin"
          elif [ -d "_output/bin" ]; then
            BIN_DIR="_output/bin"
          else
            echo "ERROR: Could not find binary output directory"
            exit 1
          fi

          mkdir -p "$GITHUB_WORKSPACE/k8s-x86_64-binaries/bin"
          mkdir -p "$GITHUB_WORKSPACE/k8s-x86_64-binaries/cni"
          mkdir -p "$GITHUB_WORKSPACE/k8s-x86_64-binaries/flannel"

          for BIN in kube-apiserver kube-controller-manager kube-scheduler kubelet kube-proxy kubectl kubeadm; do
            cp -v "$BIN_DIR/$BIN" "$GITHUB_WORKSPACE/k8s-x86_64-binaries/bin/" || true
          done

          cp -rv "$GITHUB_WORKSPACE/cni-plugins-amd64/"* "$GITHUB_WORKSPACE/k8s-x86_64-binaries/cni/"
          cp -v "$GITHUB_WORKSPACE/flannel/dist/flanneld-amd64" "$GITHUB_WORKSPACE/k8s-x86_64-binaries/flannel/flanneld"

          cat > "$GITHUB_WORKSPACE/k8s-x86_64-binaries/install.sh" << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Kubernetes binaries..."
          sudo cp -v bin/* /usr/local/bin/
          sudo chmod +x /usr/local/bin/kube*
          echo "Installing CNI plugins..."
          sudo mkdir -p /opt/cni/bin
          sudo cp -v cni/* /opt/cni/bin/
          sudo chmod +x /opt/cni/bin/*
          echo "Installing Flannel..."
          sudo cp -v flannel/flanneld /usr/local/bin/
          sudo chmod +x /usr/local/bin/flanneld
          echo "✅ Installation complete!"
          EOF

          chmod +x "$GITHUB_WORKSPACE/k8s-x86_64-binaries/install.sh"

          tar -czf "$GITHUB_WORKSPACE/kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-x86_64-linux.tar.gz" \
            -C "$GITHUB_WORKSPACE/k8s-x86_64-binaries" .

      - name: Upload x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-x86_64-linux
          path: ${{ github.workspace }}/kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-x86_64-linux.tar.gz

  build-riscv:
    needs: get-versions
    runs-on: RISCV64
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            rsync \
            jq \
            curl \
            wget

      - name: Clean workspace with elevated permissions
        run: |
          sudo rm -rf "$GITHUB_WORKSPACE"
          mkdir -p "$GITHUB_WORKSPACE"

      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          ldd --version

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Setup Go
        run: |
          GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -n1)
          wget -q "https://go.dev/dl/${GO_VERSION}.linux-riscv64.tar.gz"
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf "${GO_VERSION}.linux-riscv64.tar.gz"
          rm "${GO_VERSION}.linux-riscv64.tar.gz"
          echo "/usr/local/go/bin" >> "$GITHUB_PATH"
          /usr/local/go/bin/go version

      - name: Clone Kubernetes and checkout version
        run: |
          set -eux
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0

          rm -rf "$GITHUB_WORKSPACE/kubernetes"
          git clone --depth=1 --no-tags https://github.com/kubernetes/kubernetes.git "$GITHUB_WORKSPACE/kubernetes"
          cd "$GITHUB_WORKSPACE/kubernetes"
          git fetch --depth=1 origin tag "${{ needs.get-versions.outputs.k8s_tag }}"
          git checkout FETCH_HEAD

      - name: Build Kubernetes binaries for RISC-V
        run: |
          cd "$GITHUB_WORKSPACE/kubernetes"
          go mod download
          echo "Building Kubernetes for linux/riscv64..."
          KUBE_BUILD_PLATFORMS=linux/riscv64 make all WHAT="cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/kube-proxy cmd/kubectl cmd/kubeadm"
          echo "Build completed!"

      - name: Build CNI plugins for RISC-V
        run: |
          CNI_VERSION="${{ needs.get-versions.outputs.cni_version }}"
          rm -rf "$GITHUB_WORKSPACE/cni-plugins"
          git clone --depth=1 \
            --branch "${CNI_VERSION}" \
            https://github.com/containernetworking/plugins.git \
            "$GITHUB_WORKSPACE/cni-plugins"
          cd "$GITHUB_WORKSPACE/cni-plugins"
          ./build_linux.sh

      - name: Build Flannel for RISC-V
        run: |
          rm -rf "$GITHUB_WORKSPACE/flannel"
          git clone --depth=1 \
            --branch "${{ needs.get-versions.outputs.flannel_version }}" \
            https://github.com/flannel-io/flannel.git \
            "$GITHUB_WORKSPACE/flannel"
          cd "$GITHUB_WORKSPACE/flannel"
          GOARCH=riscv64 make dist/flanneld

      - name: Package binaries
        run: |
          cd "$GITHUB_WORKSPACE/kubernetes"

          if [ -d "_output/local/go/bin" ]; then
            BIN_DIR="_output/local/go/bin"
          elif [ -d "_output/bin" ]; then
            BIN_DIR="_output/bin"
          else
            echo "ERROR: Could not find binary output directory"
            exit 1
          fi

          mkdir -p "$GITHUB_WORKSPACE/k8s-riscv64-binaries/bin"
          mkdir -p "$GITHUB_WORKSPACE/k8s-riscv64-binaries/cni"
          mkdir -p "$GITHUB_WORKSPACE/k8s-riscv64-binaries/flannel"

          for BIN in kube-apiserver kube-controller-manager kube-scheduler kubelet kube-proxy kubectl kubeadm; do
            cp -v "$BIN_DIR/$BIN" "$GITHUB_WORKSPACE/k8s-riscv64-binaries/bin/" || true
          done

          cp -rv "$GITHUB_WORKSPACE/cni-plugins/bin/"* "$GITHUB_WORKSPACE/k8s-riscv64-binaries/cni/"
          cp -v "$GITHUB_WORKSPACE/flannel/dist/flanneld" "$GITHUB_WORKSPACE/k8s-riscv64-binaries/flannel/"

          cat > "$GITHUB_WORKSPACE/k8s-riscv64-binaries/install.sh" << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Kubernetes binaries..."
          sudo cp -v bin/* /usr/local/bin/
          sudo chmod +x /usr/local/bin/kube*
          echo "Installing CNI plugins..."
          sudo mkdir -p /opt/cni/bin
          sudo cp -v cni/* /opt/cni/bin/
          sudo chmod +x /opt/cni/bin/*
          echo "Installing Flannel..."
          sudo cp -v flannel/flanneld /usr/local/bin/
          sudo chmod +x /usr/local/bin/flanneld
          echo "✅ Installation complete!"
          EOF

          chmod +x "$GITHUB_WORKSPACE/k8s-riscv64-binaries/install.sh"

          tar -czf "$GITHUB_WORKSPACE/kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-riscv64-linux.tar.gz" \
            -C "$GITHUB_WORKSPACE/k8s-riscv64-binaries" .

      - name: Upload RISC-V artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-riscv64-linux
          path: ${{ github.workspace }}/kubernetes-${{ needs.get-versions.outputs.k8s_tag }}-riscv64-linux.tar.gz
